name: üöÄ Deploy GatePass to Production (CD)

on:
  workflow_run:
    workflows: ["üß™ Build & Test GatePass (CI)"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest

    # Run ONLY if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ==================================================
      # CHECKOUT
      # ==================================================
      - name: ‚¨áÔ∏è Checkout CI commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # ==================================================
      # NODE
      # ==================================================
      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ==================================================
      # FRONTEND ENV
      # ==================================================
      - name: üîê Create frontend .env from secret
        working-directory: frontend
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
          echo "VITE_API_URL=https://gatepass.slt.lk/api" >> .env

      # ==================================================
      # FRONTEND BUILD
      # ==================================================
      - name: üèóÔ∏è Build frontend
        working-directory: frontend
        run: |
          npm ci
          NODE_ENV=production npm run build

      - name: üîé Verify API URL inside build
        run: |
          grep -R "gatepass.slt.lk/api" frontend/dist || (echo "‚ùå API URL missing in build" && exit 1)

      # ==================================================
      # VERIFY
      # ==================================================
      - name: ‚úÖ Verify frontend build
        run: |
          test -d frontend/dist || exit 1
          test -f frontend/dist/index.html || exit 1

      - name: ‚úÖ Verify backend
        run: |
          test -d backend || exit 1
          test -f backend/server.js || exit 1

      # ==================================================
      # UPLOAD
      # ==================================================
      - name: üöö Upload artifacts
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "backend/**,frontend/dist/**,package.json"
          target: /home/dpd/GatePass-deploy
          strip_components: 0

      # ==================================================
      # DEPLOY
      # ==================================================
      - name: üîê Deploy on production server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail

            echo "üöÄ Starting GatePass deployment"

            RELEASE_TIME=$(date +"%Y%m%d-%H%M%S")
            RELEASE_DIR="/var/www/releases/release-$RELEASE_TIME"
            CURRENT_DIR="/var/www/releases/current"

            FRONTEND_ROOT="/opt/Gate_Pass"
            FRONTEND_BLUE="/opt/Gate_Pass_blue"
            FRONTEND_GREEN="/opt/Gate_Pass_green"

            BACKEND_ENV="/var/www/env/backend.env"

            mkdir -p "$RELEASE_DIR"

            echo "üì¶ Copying deployment files..."
            cp -r /home/dpd/GatePass-deploy/* "$RELEASE_DIR/"

            # ==================================================
            # RELEASE METADATA
            # ==================================================
            echo "üìù Writing release metadata..."
            cat <<EOF > "$RELEASE_DIR/RELEASE_INFO.txt"
            Release: release-$RELEASE_TIME
            Deployed at (UTC): $(date -u)
            Git commit: ${{ github.event.workflow_run.head_sha }}
            CI workflow: ${{ github.event.workflow_run.name }}
            CI run ID: ${{ github.event.workflow_run.id }}
            Branch: main
            EOF

            ln -sfn "$RELEASE_DIR" "$CURRENT_DIR"

            # =====================
            # PM2 STATUS (BEFORE)
            # =====================
            echo "üìä PM2 status BEFORE deployment"
            pm2 list || true

            # =====================
            # Backend (FRESH START)
            # =====================
            cd "$CURRENT_DIR/backend"
            ln -sfn "$BACKEND_ENV" .env

            npm ci --omit=dev

            echo "üõë Removing old PM2 process (if exists)"
            pm2 delete Gate-Pass || true

            echo "‚ñ∂Ô∏è Starting fresh PM2 process"
            pm2 start server.js --name Gate-Pass

            # =====================
            # PM2 STATUS (AFTER)
            # =====================
            echo "üìä PM2 status AFTER deployment"
            pm2 list

            echo "üîç PM2 process details"
            pm2 describe Gate-Pass | grep -E "script path|cwd|status"

            # =====================
            # Frontend (Blue/Green)
            # =====================
            mkdir -p "$FRONTEND_GREEN"
            rm -rf "$FRONTEND_GREEN"/*
            cp -r "$CURRENT_DIR/frontend/dist/"* "$FRONTEND_GREEN/"

            ln -sfn "$FRONTEND_GREEN" "$FRONTEND_ROOT"

            rm -rf "$FRONTEND_BLUE"
            cp -r "$FRONTEND_GREEN" "$FRONTEND_BLUE"

            # =====================
            # ACTIVE RELEASE CHECK
            # =====================
            echo "üìå Active release:"
            readlink -f /var/www/releases/current
            cat /var/www/releases/current/RELEASE_INFO.txt

            # =====================
            # CLEANUP
            # =====================
            echo "üßπ Cleaning up old releases..."
            cd /var/www/releases
            ls -dt release-* | tail -n +6 | xargs -d '\n' rm -rf || true

            echo "üéâ Deployment successful!"
