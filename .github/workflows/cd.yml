name: üöÄ Deploy GatePass to Production (CD)

on:
  workflow_run:
    workflows: ["üß™ Build & Test GatePass (CI)"]
    branches: [main]
    types:
      - completed

jobs:
  deploy:
    name: Production Deployment
    runs-on: ubuntu-latest

    # Run ONLY if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ==================================================
      # CHECKOUT EXACT CI COMMIT
      # ==================================================
      - name: ‚¨áÔ∏è Checkout CI commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # ==================================================
      # NODE SETUP
      # ==================================================
      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ==================================================
      # FRONTEND BUILD
      # ==================================================
      - name: üèóÔ∏è Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      # ==================================================
      # VERIFY FRONTEND DIST
      # ==================================================
      - name: ‚úÖ Verify frontend build output (dist)
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå ERROR: frontend/dist directory not found!"
            exit 1
          fi

          test -f frontend/dist/index.html || { echo "‚ùå index.html missing"; exit 1; }
          test -d frontend/dist/assets || { echo "‚ùå assets directory missing"; exit 1; }

          echo "‚úÖ frontend/dist verified"
          ls -la frontend/dist

      # ==================================================
      # VERIFY BACKEND FILES
      # ==================================================
      - name: ‚úÖ Verify backend structure
        run: |
          test -d backend || { echo "‚ùå backend directory missing"; exit 1; }
          test -f backend/server.js || { echo "‚ùå backend/server.js missing"; exit 1; }
          test -f backend/package.json || { echo "‚ùå backend/package.json missing"; exit 1; }

          echo "‚úÖ backend verified"
          ls -la backend

      # ==================================================
      # DEBUG WORKSPACE (SAFE TO REMOVE LATER)
      # ==================================================
      - name: üîç Debug workspace
        run: |
          pwd
          ls -la
          ls -la backend
          ls -la frontend/dist

      # ==================================================
      # UPLOAD TO SERVER (NO GLOB ISSUES)
      # ==================================================
      - name: üöö Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: |
            backend
            frontend/dist
          target: /home/dpd/GatePass-deploy
          rm: true

      # ==================================================
      # DEPLOY + SAFE ROLLBACK
      # ==================================================
      - name: üîê Deploy on production server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ Starting GatePass deployment"

            RELEASE_TIME=$(date +"%Y%m%d-%H%M%S")
            RELEASE_DIR="/var/www/releases/release-$RELEASE_TIME"
            CURRENT_DIR="/var/www/releases/current"

            FRONTEND_BLUE="/opt/Gate_Pass_blue"
            FRONTEND_GREEN="/opt/Gate_Pass_green"
            FRONTEND_CURRENT="/opt/Gate_Pass"

            mkdir -p "$RELEASE_DIR"
            cp -r /home/dpd/GatePass-deploy/* "$RELEASE_DIR/"
            ln -sfn "$RELEASE_DIR" "$CURRENT_DIR"

            # =====================
            # Backend
            # =====================
            cd "$CURRENT_DIR/backend"
            npm ci --production

            if pm2 describe Gate-Pass > /dev/null; then
              pm2 reload Gate-Pass --update-env
            else
              pm2 start server.js --name Gate-Pass
            fi

            pm2 save

            # =====================
            # Frontend blue-green
            # =====================
            rm -rf "$FRONTEND_GREEN"
            mkdir -p "$FRONTEND_GREEN"
            cp -r "$CURRENT_DIR/frontend/dist/"* "$FRONTEND_GREEN/"

            ln -sfn "$FRONTEND_GREEN" "$FRONTEND_CURRENT"
            sudo nginx -s reload

            # =====================
            # Health check
            # =====================
            sleep 5
            if ! curl -f https://gatepass.slt.lk/api/health; then
              echo "‚ùå Health check failed ‚Äî rolling back"

              ln -sfn "$FRONTEND_BLUE" "$FRONTEND_CURRENT"
              sudo nginx -s reload

              PREVIOUS=$(ls -dt /var/www/releases/release-* | sed -n '2p')
              if [ -n "$PREVIOUS" ]; then
                ln -sfn "$PREVIOUS" "$CURRENT_DIR"
                pm2 reload Gate-Pass
              fi
              exit 1
            fi

            rm -rf "$FRONTEND_BLUE"
            cp -r "$FRONTEND_GREEN" "$FRONTEND_BLUE"

            echo "üéâ Deployment successful!"
