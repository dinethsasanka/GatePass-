name: Build & Test GatePass (CI)


on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test (MERN)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # required for git tags

      - name: Setup Node.js (Backend)
        uses: actions/setup-node@v4
        with:
          node-version: '20'   # DevOps Change 12/16/2025 : Updated Node.js version to 20
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci
          


      - name: Run backend tests
        run: |
          cd backend
          npm test || echo "No tests found or skipped"

      # --------------------------------------------------
      # BACKEND HEALTH CHECK
      # Ensures server can start correctly
      # --------------------------------------------------
      - name: Backend health check
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}       // 12/18/25 12.27AM, 12.34AM
          PORT: 5000

        run: |
          cd backend
          node server.js &
          PID=$!
          sleep 10
          curl -f http://localhost:5000/api/health
          kill $PID

          

     
      - name: Setup Node.js (Frontend)
        uses: actions/setup-node@v4
        with:
          node-version: '20'    # DevOps Change 12/18/2025 : Updated Node.js version to 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
          

      - name: Build frontend (Vite)
        run: |
          cd frontend
          npm run build

      - name: Lint frontend
        run: |
          cd frontend
          npm run lint || echo "Lint warnings ignored"

      
      - name: Verify frontend build
        run: |
          if [ -d "frontend/dist" ]; then
           echo " Frontend build output exists: frontend/dist"
          else
           echo " Frontend build output missing! Please check the build step."
           exit 1
          fi

      - name: Auto-tag release
        if: github.event_name == 'push'
        run: |
          git fetch --tags
          LAST_TAG=$(git tag --sort=-v:refname | head -n 1)

          if [ -z "$LAST_TAG" ]; then
            NEW_TAG="v1.0.0"
          else
            VERSION=${LAST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            PATCH=$((PATCH+1))
            NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          fi

          echo "Creating tag: $NEW_TAG"
          git tag $NEW_TAG
          git push origin $NEW_TAG

      
      - name: CI completed successfully
        run: echo "CI passed ‚Äî build, test, and tagging successful"

# Test 1
      - name: ‚ùå Notify on failure
        if: failure()
        run: echo "üö® CI failed ‚Äî please check the logs"

        
