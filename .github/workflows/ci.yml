name: üß™ Build & Test GatePass (CI)

# --------------------------------------------------
# CI TRIGGERS
# - Runs on push to main
# --------------------------------------------------
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    name: Build and Test (MERN)
    runs-on: ubuntu-latest

    # --------------------------------------------------
    # PERMISSIONS
    # Required to push Git tags (auto-tagging feature)
    # --------------------------------------------------
    permissions:
      contents: write

    # --------------------------------------------------
    # DEFAULT WORKING DIRECTORY
    # Project root inside the repository
    # --------------------------------------------------
    defaults:
      run:
        working-directory: ./       // 12.17.2025 11.47PM

    steps:
      # --------------------------------------------------
      # CHECKOUT SOURCE CODE
      # fetch-depth: 0 is REQUIRED for git tags
      # --------------------------------------------------
      - name: ‚¨áÔ∏è Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # NODE.JS SETUP
      # Shared Node version for backend & frontend
      # --------------------------------------------------
      - name: üõ†Ô∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # ==================================================
      # BACKEND CI SECTION
      # ==================================================
      - name: üì¶ Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: üß™ Run backend tests
        run: |
          cd backend
          npm test || echo "‚ö†Ô∏è No tests found or tests skipped"

      # --------------------------------------------------
      # BACKEND HEALTH CHECK
      # - Starts backend
      # - Verifies /api/health endpoint
      # - Stops backend
      # --------------------------------------------------
      - name: ü©∫ Backend health verification
        run: |
          cd backend
          node server.js &
          PID=$!
          sleep 5
          curl -f http://localhost:5000/api/health
          kill $PID

      # ==================================================
      # FRONTEND CI SECTION
      # ==================================================
      - name: üì¶ Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: üèóÔ∏è Build frontend (Vite)
        run: |
          cd frontend
          npm run build

      - name: üßπ Lint frontend code
        run: |
          cd frontend
          npm run lint || echo "‚ö†Ô∏è Lint warnings ignored"

      # --------------------------------------------------
      # BUILD ARTIFACT VALIDATION
      # Ensures frontend build output exists
      # --------------------------------------------------
      - name: üìÇ Verify frontend build output
        run: |
          if [ ! -d "frontend/dist" ]; then
            echo "‚ùå Frontend build output missing"
            exit 1
          fi
          echo "‚úÖ Frontend build verified"

      # ==================================================
      # AUTO-TAGGING FEATURE
      # - Runs ONLY on push to main
      # - Automatically increments PATCH version
      # - Creates Git tag (vX.Y.Z)
      # ==================================================
      - name: üè∑Ô∏è Auto-tag release
        if: github.event_name == 'push'
        run: |
          git fetch --tags

          LAST_TAG=$(git tag --sort=-v:refname | head -n 1)

          if [ -z "$LAST_TAG" ]; then
            NEW_TAG="v1.0.0"
          else
            VERSION=${LAST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            PATCH=$((PATCH+1))
            NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          fi

          echo "Creating tag: $NEW_TAG"
          git tag $NEW_TAG
          git push origin $NEW_TAG

      # --------------------------------------------------
      # CI SUCCESS MESSAGE
      # --------------------------------------------------
      - name: ‚úÖ CI completed successfully
        run: echo "üéâ CI passed ‚Äî auto-tag created"
